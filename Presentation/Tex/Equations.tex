% Template last modified by Jake Hart; please contact course staff if you have any questions regarding using this template

\documentclass{cisXXX} % You must have the cisXXX .cls file in your project or working directory (i.e. the same directory as this document) 

\HWauthor{Wenda Zhao}{wenda.zhao@mail.utoronto.ca\\1005596302} % Put your name and Penn email on this line
\HWno{1} % Enter the number of the homework you are working on
\HWcourse{CSC2503} % Enter the course department and number here
%\HWpartner{Paul Brown} % If your class allows group work, put your partners here
%\HWpartner{Amelia Earhart} % Otherwise, delete or comment these lines 
\usepackage{amsmath}
\usepackage{listings}
\usepackage{tabularx}
\usepackage{array}
\usepackage{bm}
\usepackage{cite}
\definecolor{mygreen}{rgb}{0,0.6,0}
\bibliography{bib/TR-Template-bib}{}
\bibliographystyle{plain}

%\usepackage{\xcolor}
%\renewcommand\arraystretch{2}
%\notice{*}%
%\bibliographystyle{ieeetr}
    %\setlength{\parskip}{1pt}
%{\normalsize
%        \bibliography{bib/TR-Template-bib}}
        
\begin{document}
\maketitle


\newpage

State vector~:~$X=(x,y,z,v_x,v_y,v_z,q_0,q_1,q_2,q_3)^T$

Postion and velocity are in world frame

Motion model

\begin{equation}
\begin{split}
\check{X}_k &= \hat{X}_{k-1}+\delta t\hat{V}_{k-1}+\frac{1}{2}\delta t^2\left(\hat{C}_{k-1}^T f_k-e_3g\right) \\
\check{V}_k &= \hat{V}_{k-1}+\delta t\left(\hat{C}_{k-1}^T f_k-e_3 g\right) \\
\check{q}_k &= \zeta\left(\delta t \hat{w}_k\right)\otimes \hat{q}_{k-1}
\end{split}
\end{equation}


 $C:$ Rotation matrix from world to body, $e_3=(0,0,1)^T$, $g:$ Acceleration of gravity, $\otimes:$ quaternion multiplication operator and $\zeta(\cdot)$ is the mapping from error rotation vector to quaternion error.
\begin{equation}
\renewcommand\arraystretch{1.7}
 \zeta(v)=\begin{bmatrix}
  sin\left(\frac{1}{2}\|v\|\right)\frac{v}{\|v\|}  \\
  cos\left(\frac{1}{2}\|v\|\right)
 \end{bmatrix}_{4\times 1} 
\end{equation} 

Jacobian matrix
\begin{equation}
\renewcommand\arraystretch{1.7}
F=\begin{bmatrix}
 I   & \delta tI & -\frac{1}{2} \delta t^2 \hat{C}_{k-1}^T f_k^{\times}   \\
 0   & I         & -\delta t \hat{C}_{k-1}^T f_k^{\times}   \\
 0   & 0         & [exp(\delta t w^{\times})]^T
\end{bmatrix}_{9\times 9}
\end{equation}

Process noise convariance matrix $Q_k'$
\begin{equation}
\renewcommand\arraystretch{1.7}
Q_k' = \begin{bmatrix}
\frac{\delta t^3}{3} Q_f    & \frac{\delta t^2}{2} Q_f  &0 \\
\frac{\delta t^2}{2} Q_f    & \delta t Q_f              &0 \\
0                           &  0                   & \delta Q_w    
\end{bmatrix}_{9\times 9}
\end{equation}

$Q_f: $ Variance of acceleration data, $Q_w: $ Variance of gyroscope data

Prediction step
\begin{equation}
\begin{split}
\check{P}_k &= F_{k-1}\hat{P}_{k-1}F_{k-1}^T+Q_k'  \\
\check{X}_k &= f(\hat{X}_{k-1},V_k,0)
\end{split}
\end{equation}

\newpage
Observation model

\begin{equation}
\renewcommand\arraystretch{1.2}
y=\begin{bmatrix}
\tilde{v_x}   \\
\tilde{v_y}   \\
\tilde{v_z}   \\
\end{bmatrix}=\begin{bmatrix}
\bm{0}_{3\times 3} & \check{C}
\end{bmatrix}\begin{bmatrix}
	x   \\
	y   \\
	z   \\
	v_x   \\
	v_y   \\
	v_z   
\end{bmatrix}
\end{equation}
$(\tilde{v_x},\tilde{v_y},\tilde{v_z}):$ velocity in body frame

Jacobian matrix
\begin{equation}
G=\frac{\partial y}{\partial x}=\begin{bmatrix}
\bm{0}_{3\times 3} & -\check{C}_k  &(\check{C}_k(v_x,v_y,v_z)^T)^{\times} 
\end{bmatrix}_{3\times 9}
\end{equation}

Measurement noise convariance matrix $R_k'$
\begin{equation}
R_k'=\begin{bmatrix}
R_{vx}  & 0   & 0 \\
0  & R_{vy}   & 0 \\
0  & 0   & R_{vz} 
\end{bmatrix}
\end{equation}

Correction step
\begin{equation}
\begin{split}
&K_k = \check{P}_k G_k^T\left(G_k\check{P}_k G_k^T + R_k'\right)^{-1}   \\
&\hat{P}_k  = (\bm{1}-K_k G_k)\check{P}_k  \\
&x_{update} = K_k(y_k-g(\check{x}_k,0)) 
\end{split}
\end{equation}

Update position and velocity

\begin{equation}
\hat{x}_k\small{(1:6)} = \check{x}_k\small{(1:6)}+x_{update}\small{(1:6)}
\end{equation}

Update attitude
\begin{equation}
\begin{split}
\hat{q}_k &= \zeta(\delta \phi_k)\otimes \check{q}_k    \\
		  &= \zeta(x_{update}\tiny{(7:9)})\otimes \check{q}_k  \\
		  &= \hat{x}_k\small{(7:10)}
\end{split}
\end{equation}

\newpage
Observation model $2$

\begin{equation}
\renewcommand\arraystretch{1.2}
y=\begin{bmatrix}
\tilde{x}   \\
\tilde{y}   \\
\tilde{z}   \\
\end{bmatrix}=\begin{bmatrix}
\check{C} & \bm{0}_{3\times 3}  
\end{bmatrix}\begin{bmatrix}
	x   \\
	y   \\
	z   \\
	v_x   \\
	v_y   \\
	v_z   
\end{bmatrix}
\end{equation}
$(\tilde{x},\tilde{y},\tilde{z}):$ position in body frame

Jacobian matrix
\begin{equation}
G=\frac{\partial y}{\partial x}=\begin{bmatrix}
-\check{C}_k  & \bm{0}_{3\times 3} & (\check{C}_k(x, y ,z)^T)^{\times} 
\end{bmatrix}_{3\times 9}
\end{equation}

Measurement noise convariance matrix $R_k'$
\begin{equation}
R_k'=\begin{bmatrix}
R_{x}  & 0   & 0 \\
0  & R_{y}   & 0 \\
0  & 0   & R_{z} 
\end{bmatrix}
\end{equation}

Correction step
\begin{equation}
\begin{split}
&K_k = \check{P}_k G_k^T\left(G_k\check{P}_k G_k^T + R_k'\right)^{-1}   \\
&\hat{P}_k  = (\bm{1}-K_k G_k)\check{P}_k  \\
&x_{update} = K_k(y_k-g(\check{x}_k,0)) 
\end{split}
\end{equation}

Update position and velocity

\begin{equation}
\hat{x}_k\small{(1:6)} = \check{x}_k\small{(1:6)}+x_{update}\small{(1:6)}
\end{equation}

Update attitude
\begin{equation}
\begin{split}
\hat{q}_k &= \zeta(\delta \phi_k)\otimes \check{q}_k    \\
		  &= \zeta(x_{update}\tiny{(7:9)})\otimes \check{q}_k  \\
		  &= \hat{x}_k\small{(7:10)}
\end{split}
\end{equation}

\newpage
Observation model $3$

Measurements $y=(\tilde{z}, \tilde{v_x}, \tilde{v_y})^T$ are in body frame.

\begin{equation}
\begin{split}
\tilde{z} &= \check{C}_{31}\check{x}_{k-1}+\check{C}_{32}\check{y}_{k-1}+\check{C}_{33}\check{z}_{k-1}   \\
\tilde{v_x} &= \check{C}_{11}\check{v}_{x_{k-1}}+\check{C}_{12}\check{V}_{y_{k-1}}+\check{C}_{13}\check{v}_{z_{k-1}}    \\
\tilde{v_y} &= \check{C}_{21}\check{V}_{x_{k-1}}+\check{C}_{22}\check{V}_{y_{k-1}}+\check{C}_{23}\check{v}_{z_{k-1}}
\end{split}
\end{equation}


Jacobian matrix
\begin{equation}
\begin{aligned}
\renewcommand\arraystretch{1.5} 
G&= \left[\begin{matrix}
C_{31}   & C_{32}   & C_{33} &0  &0 &0  &-C_{32}x+C_{31}y       \\
0  &0  &0  &C_{11}   &C_{12}  &C_{13}  & -C_{12}v_x+C_{11}v_y   \\
0  &0  &0  & C_{21}  & C_{22}  & C_{23}  &-C_{22}v_x + C_{21}v_y
\end{matrix}\right. \\
&\qquad\qquad
\left.\begin{matrix} \frac{C_{33}(C_{11}x+C_{12}y+C_{13}z)}{-sgn(C_{23})\sqrt{C_{23}^2+C_{33}^2}}   & -C_{21}v_x-C_{22}y-C_{23}z   \\
 \frac{C_{13}(C_{11}v_x+C_{12}v_y)}{-sgn(C_{23})\sqrt{C_{23}^2+C_{33}^2}} + (sgn(C_{23})\sqrt{C_{23}^2+C_{33}^2})v_z  &0   \\
   \frac{C_{23}(C_{11}v_x+C_{12}v_y+C_{13}v_z)}{-sgn(C_{23})\sqrt{C_{23}^2+C_{33}^2}}   &C_{31}v_x+C_{32}v_y+C_{33}v_z
\end{matrix}\right]_{3\times 9}
\end{aligned}
\end{equation}

Measurement noise convariance matrix $R_k'$
\begin{equation}
R_k'=\begin{bmatrix}
R_{z}  & 0   & 0 \\
0  & R_{vx}   & 0 \\
0  & 0   & R_{vy} 
\end{bmatrix}
\end{equation}

Correction step
\begin{equation}
\begin{split}
&K_k = \check{P}_k G_k^T\left(G_k\check{P}_k G_k^T + R_k'\right)^{-1}   \\
&\hat{P}_k  = (\bm{1}-K_k G_k)\check{P}_k  \\
&x_{update} = K_k(y_k-g(\check{x}_k,0)) 
\end{split}
\end{equation}

Update position and velocity

\begin{equation}
\hat{x}_k\small{(1:6)} = \check{x}_k\small{(1:6)}+x_{update}\small{(1:6)}
\end{equation}

Update attitude
\begin{equation}
\begin{split}
\hat{q}_k &= \zeta(\delta \phi_k)\otimes \check{q}_k    \\
		  &= \zeta(x_{update}\tiny{(7:9)})\otimes \check{q}_k  \\
		  &= \hat{x}_k\small{(7:10)}
\end{split}
\end{equation}

\newpage
$$
v_x =Z_{range}\frac{\theta_{pj}\delta_x}{\delta_t N_{pix}}  
$$

$$ 
v_y =Z_{range}\frac{\theta_{pj}\delta_y}{\delta_t N_{pix}}   
$$
where $Z_{range}$ is the data from flowdeck range sensor, $\theta_{pj}$ is constant number($\frac{4.2\pi}{180}$), $N_{pix}$ is the total pixel number ($30$) and $\delta_t$ is $0.01s$.

\newpage

State vector~:~$X=(x,y,z,v_x,v_y,v_z,q_0,q_1,q_2,q_3,bf_x, bf_y, bf_z, bw_x, bw_y, bw_z)^T$

Postion and velocity are in world frame. $Bf=(bf_x, bf_y, bf_z)^T$ is the bias of acceleration data and $Bw=(bw_x, bw_y, bw_z)^T$ is the bias of gyroscope data.

Motion model

\begin{equation}
\begin{split}
\check{X}_k &= \hat{X}_{k-1}+\delta t\hat{V}_{k-1}+\frac{1}{2}\delta t^2\left(\hat{C}_{k-1}^T f_k-e_3g\right) \\
\check{V}_k &= \hat{V}_{k-1}+\delta t\left(\hat{C}_{k-1}^T f_k-e_3 g\right) \\
\check{q}_k &= \zeta\left(\delta t w_k\right)\otimes \hat{q}_{k-1}  \\
\check{B}_f &= \hat{B}_f   \\
\check{B}_w &= \hat{B}_w
\end{split}
\end{equation}
with the bias corrected IMU measurements 
$$
f_k=\tilde{f}_k-B_{fk}
$$
$$
w_k=\tilde{w}_k-B_{wk}
$$

The bias terms are modeled as Brownian motions and their derivatives can be represented by white Gaussian noise process $w_{bf}$ and $w_{bw}$.
$$
\dot{B}_{fk}=w_{bf}
$$
$$
\dot{B}_{wk}=w_{bw}
$$


 $C:$ Rotation matrix from world to body, $e_3=(0,0,1)^T$, $g:$ Acceleration of gravity, $\otimes:$ quaternion multiplication operator and $\zeta(\cdot)$ is the mapping from error rotation vector to quaternion error.
\begin{equation}
\renewcommand\arraystretch{1.7}
 \zeta(v)=\begin{bmatrix}
  sin\left(\frac{1}{2}\|v\|\right)\frac{v}{\|v\|}  \\
  cos\left(\frac{1}{2}\|v\|\right)
 \end{bmatrix}_{4\times 1} 
\end{equation} 

Jacobian matrix
\begin{equation}
\renewcommand\arraystretch{1.7}
F=\begin{bmatrix}
 I   & \Delta tI & -\frac{1}{2} \Delta t^2 \hat{C}_{k-1}^T f_k^{\times}  & -\frac{\Delta t^2}{2}\hat{C}_{k-1}^T &0 \\
 0   & I         & -\Delta t \hat{C}_{k-1}^T f_k^{\times}  &-\Delta t \hat{C}_{k-1}^T     &0 \\
 0   & 0         & [exp(\Delta t w^{\times})]^T & 0            & -\hat{\Gamma}^T_{1,k}
\end{bmatrix}_{15\times 15}
\end{equation}

Process noise convariance matrix $Q_k'$
\begin{equation}
\renewcommand\arraystretch{1.7}
Q_k' = \begin{bmatrix}
\frac{\Delta t^3}{3} Q_f + \frac{\Delta t^5}{20} Q_bf    & \frac{\Delta t^2}{2} Q_f + \frac{\Delta t^4}{8} Q_bf  &0    &-\frac{\Delta t^3}{6} \hat{C}_k^T Q_{bf}  &0\\
\frac{\Delta t^2}{2} Q_f + \frac{\Delta t^4}{8} Q_bf   & \Delta t Q_f + \frac{\Delta t^3}{3} Q_bf            &0   &-\frac{\Delta t^2}{2} \hat{C}_k^T Q_{bf}  &0\\
0                           &  0                   & \Delta t Q_w +(\hat{\Gamma}_{3,k}+\hat{\Gamma}_{3,k}^T) Q_{bw} &0 &-\hat{\Gamma}_{2,k}^T Q_{bw}   
\end{bmatrix}_{15\times 15}
\end{equation}

$Q_f: $ Variance of acceleration data, $Q_w: $ Variance of gyroscope data, $Q_bf: $ variance of bias in acceleration data,$Q_bw: $variance of bias in gyroscope data

Prediction step
\begin{equation}
\begin{split}
\check{P}_k &= F_{k-1}\hat{P}_{k-1}F_{k-1}^T+Q_k'  \\
\check{X}_k &= f(\hat{X}_{k-1},V_k,0)
\end{split}
\end{equation}
\end{document}






